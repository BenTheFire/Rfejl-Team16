@page "/admin/edit/movies"
@using Ticketmaster.Data.Services.Interfaces
@using Ticketmaster.Objects
@inject IMovieService MS
@using Ticketmaster.Data.Services.StaticServiceMethods
@using Ticketmaster.Extra
<body>
    <div class="forms">
        <div class="container my-4">
            <div class="row g-4">
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="formContainer">
                        <h4>Create movie</h4>
                        <form onsubmit="@createMovie">
                            <input type="text" class="form-control mb-2" placeholder="Title of movie" @bind-value="M.Title" />
                            <input type="text" class="form-control mb-2" placeholder="Description of movie" @bind-value="M.Description" />
                            <input type="number" class="form-control mb-2" placeholder="Length in seconds" @bind-value="M.LengthInSeconds" />
                            <input type="text" class="form-control mb-2" placeholder="Image source link" @bind-value="M.ImageSource" />
                            <input type="text" class="form-control mb-2" placeholder="Release date" @bind-value="M.ReleaseDate" />
                            <input type="number" class="form-control mb-2" placeholder="IMDb ID" @bind-value="M.ImdbId" />
                            <button type="submit" class="btn btn-success w-100">Create Movie</button>
                        </form>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="formContainer">
                        <h4>Fetch movie from Omdb by title or Imdb ID</h4>
                        <form onsubmit="@fetchMovie">
                            <input type="text" class="form-control mb-2" placeholder="Title of movie" @bind-value="M.Title" />
                            <input type="number" class="form-control mb-2" placeholder="Imdb ID of movie" @bind-value="M.ImdbId" />
                            <button type="submit" class="btn btn-success mb-2 w-100">Fetch Movie</button>
                            <div class="form-check">
                                <InputCheckbox @bind-Value="force" class="form-check-input" id="forceCheck" />
                                <label class="form-check-label" for="forceCheck">Force</label>
                            </div>
                        </form>
                        <p>@textAdd</p>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="formContainer">
                        <h4>Update movie</h4>
                        <ul>
                            @foreach (var movie in movies)
                            {
                                <li>
                                    <a href="@HrefMovieLink(movie)">@movie.Title (@movie.ReleaseDate)</a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="formContainer">
                        <h4>Delete movie</h4>
                        <form onsubmit="@deleteMovie">
                            <input type="text" class="form-control mb-2" placeholder="Movie's Title to delete" @bind-value="M.Title" />
                            <input type="number" class="form-control mb-2" placeholder="Movie's IMDb ID to delete" @bind-value="M.ImdbId" />
                            <button type="submit" class="btn btn-danger w-100">Delete Movie</button>
                        </form>
                        @textDelete
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
@code {
    private bool isInDBAdd = false;
    private bool successAdd = false;
    private bool isNotInDBDelete = false;
    private bool successDelete = false;
    private bool force = false;
    private bool doesntExistAdd = false;
    private string textAdd = "";
    private string textDelete = "";
    private Movie M = new();
    private List<Movie> movies = new();

    private string HrefMovieLink(Movie movie) => $"admin/edit/movie/{(movie.ImdbId):D7}";


    protected override async Task OnInitializedAsync()
    {
        movies = await MS.GetMovies();
    }

    private void ResetFetchMovieStatus()
    {
        isInDBAdd = false;
        successAdd = false;
        doesntExistAdd = false;
    }

    private async Task fetchMovie() {
        ResetFetchMovieStatus();
        if (M.ImdbId == 0 && M.Title.IsNullOrEmpty())
        {
            textAdd = "Please provide a title or IMDb ID to fetch the movie.";
            return;
        }
        if (await MS.IsInDBByTitle(M.Title) || await MS.IsInDBByImdbId(M.ImdbId.ToString()))
        {
            isInDBAdd = true;
            textAdd = "Movie already in database";
        }
        else if (M.ImdbId != 0)
        {
            //imdbid fetch

            if (!force)
            {
                if (isInDBAdd) return;
                await foreach (var item in OmdbSource.FetchMovieByTitle(M.Title))
                {
                    if (item == null)
                    {
                        textAdd = $"Movie with Imdb ID {M.ImdbId} doesn't exist in Omdb";
                        doesntExistAdd = true;
                        return;
                    }
                    await MS.CreateMovie(item);
                    isInDBAdd = false;
                    successAdd = true;
                    doesntExistAdd = false;
                    textAdd = $"Movie {M.ImdbId} added succesfully";
                    return;
                }
            }
            else
            {
                if (isInDBAdd)
                {
                    await MS.UpdateMovieFromOmdbByTitle(M.Title);
                    successAdd = true;
                    doesntExistAdd = false;
                    textAdd = $"Movie {M.ImdbId} updated forcefully";
                    return;
                }
                else
                {
                    await foreach (var item in OmdbSource.FetchMovieByTitle(M.Title))
                    {
                        if (item == null)
                        {
                            doesntExistAdd = true;
                            textAdd = $"Movie {M.ImdbId} doesn't exist in Omdb";
                            return;
                        }
                        await MS.CreateMovie(item);
                        successAdd = true;
                        doesntExistAdd = false;
                        textAdd = $"Movie {M.ImdbId} created forcefully";
                        return;
                    }
                }
            }
        }
        else
        {
            //title fetch
            if (!force)
            {
                if (isInDBAdd) return;
                await foreach (var item in OmdbSource.FetchMovieByTitle(M.Title))
                {
                    if (item == null)
                    {
                        textAdd = $"Movie with title {M.Title} doesn't exist in Omdb";
                        doesntExistAdd = true;
                        return;
                    }
                    await MS.CreateMovie(item);
                    isInDBAdd = false;
                    successAdd = true;
                    doesntExistAdd = false;
                    textAdd = $"Movie {M.Title} added succesfully";
                    return;
                }
            }
            else
            {
                if (isInDBAdd)
                {
                    await MS.UpdateMovieFromOmdbByTitle(M.Title);
                    successAdd = true;
                    doesntExistAdd = false;
                    textAdd = $"Movie {M.Title} updated forcefully";
                    return;
                }
                else
                {
                    await foreach (var item in OmdbSource.FetchMovieByTitle(M.Title))
                    {
                        if (item == null)
                        {
                            doesntExistAdd = true;
                            textAdd = $"Movie {M.Title} doesn't exist in Omdb";
                            return;
                        }
                        await MS.CreateMovie(item);
                        successAdd = true;
                        doesntExistAdd = false;
                        textAdd = $"Movie {M.Title} created forcefully";
                        return;
                    }
                }
            }
        }
        

        
    }
    private async Task createMovie()
    {
        await MS.CreateMovie(M);
    }

    private async Task updateMovie()
    {
        await MS.UpdateMovie(M);
    }

    private async Task deleteMovie()
    {
        if (string.IsNullOrEmpty(M.Title) && M.ImdbId == 0)
        {
            textDelete = "Please provide a title or IMDb ID to delete the movie.";
            return;
        } 
        else if (!string.IsNullOrEmpty(M.Title))
        {
            if (!await MS.IsInDBByTitle(M.Title))
            {
                isNotInDBDelete = true;
                textDelete = $"Movie with title {M.Title} doesn't exist in database";
                return;
            }
            isNotInDBDelete = false;
            await MS.DeleteMovieByTitle(M.Title);
            successDelete = true;
            textDelete = $"Movie {M.Title} deleted successfully";
            return;
        }
        else
        {
            if (!await MS.IsInDBByImdbId(M.ImdbId.ToString()))
            {
                isNotInDBDelete = true;
                textDelete = $"Movie with IMDb ID {M.ImdbId} doesn't exist in database";
                return;
            }
            isNotInDBDelete = false;
            await MS.DeleteMovieByImdbId(M.ImdbId.ToString());
            successDelete = true;
            textDelete = $"Movie {M.Title} deleted successfully";
            return;
        }

    }
}
<style>
    .forms {
        align-content: normal;
        justify-content: normal;
        gap: 3rem; 
    }
    .formContainer {
        background: #23272f;
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        border: 1px solid #2c313c;
        color: #f8f9fa;
        padding: 1.5rem 1.5rem 1rem 1.5rem;
        margin: 0.5rem 0;
        min-height: 100%;
    }

        .formContainer h4 {
            margin-bottom: 1rem;
            color: #aee1f9;
        }


    .formContainer {
        display: flex;
        flex-direction: column;
        min-width: 220px;
        padding: 1.5rem 1.5rem 1rem 1.5rem;
        margin: 0.5rem 0;
        background: #23272f;
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        border: 1px solid #2c313c;
        color: #f8f9fa;
    }

        .formContainer h4 {
            margin-bottom: 1rem;
            color: #aee1f9;
        }

        .formContainer input,
        .formContainer button {
            margin-bottom: 0.7rem;
            border-radius: 0.4rem;
            border: 1px solid #444;
            padding: 0.5rem;
            background: #181a20;
            color: #f8f9fa;
        }

        .formContainer button {
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

    .buttonDelete {
        background-color: #e74c3c;
    }

    .buttonAdd {
        background-color: #27ae60;
    }

    .buttonEdit {
        background-color: #2980b9;
    }
</style>
